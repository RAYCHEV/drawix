<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Drawing Measurement Tool</title>
    <meta name="description" content="Professional web application for measuring areas on construction drawings and blueprints with calibrated measurements.">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Main Content Area -->
        <div class="main-section">
            <header class="app-header">
                <h1 class="app-title">Construction Drawing Measurement Tool</h1>
            </header>
            
            <main class="canvas-container">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <!-- Empty state -->
                    <div class="empty-state" id="emptyState">
                        <p class="empty-state-title">Upload a drawing to begin</p>
                        <p class="empty-state-subtitle">Supported formats: JPG, PNG, PDF</p>
                    </div>
                    
                    <!-- Loading state -->
                    <div class="loading-state hidden" id="loadingState">
                        <div class="spinner"></div>
                        <span>Loading image...</span>
                    </div>
                    
                    <!-- Canvas -->
                    <canvas id="measurementCanvas" class="measurement-canvas hidden"></canvas>
                    
                    <!-- Zoom controls -->
                    <div class="zoom-controls hidden" id="zoomControls">
                        <button class="zoom-btn" id="zoomOutBtn" data-testid="button-zoom-out" title="Zoom Out">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/><line x1="8" x2="14" y1="11" y2="11"/></svg>
                        </button>
                        <div class="zoom-display">
                            <span id="zoomLevel">100%</span>
                        </div>
                        <button class="zoom-btn" id="zoomInBtn" data-testid="button-zoom-in" title="Zoom In">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/><line x1="8" x2="14" y1="11" y2="11"/><line x1="11" x2="11" y1="8" y2="14"/></svg>
                        </button>
                        <div class="zoom-divider"></div>
                        <button class="zoom-btn" id="resetViewBtn" data-testid="button-reset-view" title="Reset View">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
                        </button>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Tool Panel -->
        <aside class="tool-panel">
            <!-- File Upload Section -->
            <div class="panel-section">
                <h2 class="panel-section-title">Upload Drawing</h2>
                <div class="upload-area" id="uploadArea" data-testid="upload-area">
                    <input type="file" id="fileInput" accept="image/jpeg,image/png,application/pdf" hidden>
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    <p class="upload-text">Click to upload</p>
                    <p class="upload-subtext">JPG, PNG or PDF</p>
                </div>
            </div>
            
            <!-- Project Name & Screenshot -->
            <div class="panel-section">
                <h2 class="panel-section-title">Project</h2>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label for="projectNameInput" class="form-label" style="font-size: 0.75rem; margin-bottom: 0.375rem;">Project Name</label>
                    <input 
                        type="text" 
                        id="projectNameInput" 
                        class="form-input" 
                        placeholder="Enter project name"
                        style="font-size: 0.875rem; padding: 0.5rem 0.75rem;"
                    >
                </div>
                <button class="control-btn control-btn-primary" id="screenshotBtn" title="Take screenshot with project information">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span>Take Screenshot</span>
                </button>
            </div>
            
            <!-- Tool Selection -->
            <div class="panel-section">
                <h2 class="panel-section-title">Tools</h2>
                <div class="tools-grid">
                    <button class="tool-btn active" id="toolLine" data-tool="line" title="Line Tool">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span>Line</span>
                    </button>
                    <button class="tool-btn" id="toolRectangle" data-tool="rectangle" title="Rectangle Tool">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        <span>Rectangle</span>
                    </button>
                    <button class="tool-btn" id="toolPipe" data-tool="pipe" title="Pipe Tool">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                        <span>Pipe</span>
                    </button>
                    <button class="tool-btn" id="toolSubtract" data-tool="subtract" title="Subtract Tool - Draw polygon to subtract from existing polygon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        <span>Subtract</span>
                    </button>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="panel-section">
                <h2 class="panel-section-title">Controls</h2>
                <div class="controls-grid">
                    <button class="control-btn control-btn-primary" id="newProjectBtn" title="Start a new project (refresh page)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M2 12h20"/><circle cx="12" cy="12" r="10"/></svg>
                        <span>New Project</span>
                    </button>
                    <button class="control-btn" id="recalibrateBtn" data-testid="button-recalibrate" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                        <span>Recalibrate</span>
                    </button>
                    <button class="control-btn" id="undoBtn" data-testid="button-undo" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                        <span>Undo Line</span>
                    </button>
                    <button class="control-btn control-btn-danger" id="clearBtn" data-testid="button-clear" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        <span>Clear All Drawings</span>
                    </button>
                    <button class="control-btn" id="toggleLengthLabelsBtn" title="Toggle line length labels">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="15" x2="15" y2="15"/><line x1="12" y1="3" x2="12" y2="21"/></svg>
                        <span>Show Lengths</span>
                    </button>
                    <button class="control-btn" id="toggleAngleSnapBtn" title="Toggle 90-degree angle snapping">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 12 12 3 21 12"/><polyline points="3 21 12 12 21 21"/></svg>
                        <span>90° Snap</span>
                    </button>
                </div>
            </div>
            
            <!-- Calibration Info -->
            <div class="panel-section" id="calibrationSection">
                <h2 class="panel-section-title">Calibration</h2>
                <div class="info-card" id="calibrationInfo">
                    <p class="info-text">Draw a reference line first</p>
                </div>
            </div>
            
            <!-- Total Area -->
            <div class="panel-section" id="totalAreaSection">
                <h2 class="panel-section-title">Total Area</h2>
                <div class="info-card">
                    <p class="metric-value" id="totalArea">0.00 m²</p>
                </div>
            </div>
            
            <!-- Polygons List -->
            <div class="panel-section collapsible">
                <button class="collapsible-header" id="polygonsHeader">
                    <h2 class="panel-section-title">Polygons</h2>
                    <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="collapsible-content" id="polygonsList">
                    <p class="info-text">No polygons detected</p>
                </div>
            </div>
            
            <!-- Pipes List -->
            <div class="panel-section collapsible">
                <button class="collapsible-header" id="pipesHeader">
                    <h2 class="panel-section-title">Pipes</h2>
                    <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="collapsible-content collapsed" id="pipesList">
                    <p class="info-text">No pipes yet</p>
                </div>
            </div>
            
            <!-- Points List -->
            <div class="panel-section collapsible">
                <button class="collapsible-header" id="pointsHeader">
                    <h2 class="panel-section-title">Points</h2>
                    <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="collapsible-content collapsed" id="pointsList">
                    <p class="info-text">No points yet</p>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="panel-section collapsible">
                <button class="collapsible-header" id="instructionsHeader">
                    <h2 class="panel-section-title">Instructions</h2>
                    <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="collapsible-content collapsed" id="instructionsContent">
                    <ol class="instructions-list">
                        <li>Upload a construction drawing (JPG, PNG, or PDF)</li>
                        <li><strong>Before drawing:</strong> Use mouse wheel or buttons to zoom the image</li>
                        <li>Click to place the first point of your reference line</li>
                        <li>Click again to complete the line and calibrate</li>
                        <li>Enter the real-world length in meters</li>
                        <li><strong>After first point:</strong> Zoom is locked, use Shift+drag or right mouse button drag to pan the image</li>
                        <li>Continue drawing lines - they snap to existing points</li>
                        <li>Close polygons to automatically calculate area</li>
                        <li>Click on a polygon name in the menu to rename it</li>
                        <li><strong>Important:</strong> Please do not overlap polygons because it will take the value twice, same for extraction</li>
                    </ol>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Calibration Modal -->
    <dialog id="calibrationModal" class="calibration-modal">
        <div class="modal-content">
            <h2 class="modal-title">Calibrate Measurement</h2>
            <p class="modal-description">Enter the real-world length of the line you just drew</p>
            
            <form id="calibrationForm" class="calibration-form">
                <div class="form-group">
                    <label for="lengthInput" class="form-label">Length (meters)</label>
                    <input 
                        type="number" 
                        id="lengthInput" 
                        class="form-input" 
                        step="0.01" 
                        min="0.01" 
                        placeholder="e.g., 5.0"
                        data-testid="input-calibration-length"
                        required
                        autofocus
                    >
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCalibrationBtn" data-testid="button-cancel-calibration">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" data-testid="button-submit-calibration">
                        Set Calibration
                    </button>
                </div>
            </form>
        </div>
    </dialog>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <div class="toast-content">
            <span id="toastMessage"></span>
        </div>
    </div>
    
    <!-- Application Script -->
    <script src="app.js"></script>
</body>
</html>
